name: Deploy by ssh

env:
  SSH_USERNAME: "ubuntu"
  SSH_HOST_NAME: "ec2-3-68-232-223.eu-central-1.compute.amazonaws.com"
  SSH_PORT: "22"
  DEPLOY_SSH_KEY: "PuTTY-User-Key-File-3: ssh-rsa
Encryption: none
Comment: rsa-key-20240712
Public-Lines: 6
AAAAB3NzaC1yc2EAAAADAQABAAABAQCyIgqBwfeDyQGxF0HVmW37IDIJqu48SG77
yducdD8LIVAvjpSOVJku56XQ4awcDBbjPz9UDyEdwl4kKXS7/y2rmldvLdf9jD2C
I0Ju7qjFwKjS+ve9RhQGJ3X9faeFjhvXKRidZCS0QMLfB5sRZUIiaDVFifArSgh/
8IKikNmRqrxAE3rHqXpVZJvN7vAYEFlI480rThPAfZ4bjKmP4V+624/L8L7eb6Gt
MIzQkO2VVfmCatuVeEywar8vVKi2FLtAivNiyEZvuU9Au+bkgrT+AffUs4HTXOPQ
aIXIMp2jsLbHPUOF3r0nbmgxWX6Rc5MmY6UB1tDwBGOSrRv9gDRr
Private-Lines: 14
AAABAQClTF9xn5vep9UxD0LhQnpDcdHdFMf0GscaUWvAGEM0QdqV9vo1xZ1MYFuH
pRLACBvpDpTmnQ9+/RG8/tc7aQVpW1TNb74ho1SkgbGxHThyIWDIP2lLM097kny0
GTkt/vwowhL8YqSIvBvZOMaV8t/W69qbR/AdS5rtljKzRjUPLNMleVMRdL1huDTs
suGo9wrVX2f7v1Jfviea2aRFnUsXiJV4DeV6lEQtf9IFUyWnt/7kAXNhrq30Qc9B
ihDceoXSePaiKY3bTXg35OiYDh6usXp7EF5+DWpEcDlr0a6DaqEgwCAM6VWTzhWL
t/S58JjkexL4Wha/Vvpa6CVYAHk5AAAAgQDWTjNGniQOaScvhQIX6oure2K6ozsM
2oTaUdLiBCR34ApoMVhBsulAMw7OAv9WfOxR7rziF+TwNJrT3XAkEBkR/WfdR7zU
JhOHkpS/LmpXuuzL18I8ubw+w3b5rR/r7UN+t8ZGJOlh3rBG1bSNGrTa4EE0/QPl
oRDpGeuNBCVIdwAAAIEA1Mo3Ws5kCoAuDj7MR0ETqdcCGaDKiOuz7PLGjPC2dT5m
+GmwM/TkHDk78WeWxa2ZMr0C2DoCRj2whuNybCnoIuU6fq+FXrXAA/rLaEOSs5hf
6i3JKNpIlcmef7eQg65y9VwGoYX6sBz4O33G5SOPWNG89SI5BAMX0wxY15uupK0A
AACAR55Pu13QH4jP38YBJZ7rREqt7jjWXHv2r8EpySybgZgVeH2ExhJXJ4jKgeiD
JvaK9XNn+XqNPw+1oc/+hwTyuJ1bFHqZtIzJvG2PEyBSKyux0pg15s5sAtgebu38
+3wX6Xg0p3OEX2vh5C+Y93hoxmOB1tN3aBgXxxajqe69nqA=
Private-MAC: 98dcbfe63f7efb505d411835e36c9570790721d02bf7e63358a8c821d6df03f7
"

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Change directory permitions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST_NAME }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            bash
            if [ -d /home/${{ env.SSH_USERNAME }}/Crystall/ ]; then
              sudo chmod -R 777 /home/${{ env.SSH_USERNAME }}/Crystall/ && echo "chmod done"
              sudo chown -R ${{ env.SSH_USERNAME }}:${{ env.SSH_USERNAME }} /home/${{ env.SSH_USERNAME }}/Crystall/ && echo "chown done"
            else
              echo "/home/${{ env.SSH_USERNAME }}/Crystall/ not found"
            fi
       
            
      - name: Refresh content
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
      - name: Sync Repository via SSH
        run: |
          rsync -e "ssh -i $HOME/.ssh/key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" --archive --compress --delete \
          . ${{ env.SSH_USERNAME }}@${{ env.SSH_HOST_NAME }}:Crystall

      - name: Change directory permitions again
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST_NAME }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            if [ -d /home/${{ env.SSH_USERNAME }}/Crystall/ ]; then
              sudo chmod -R 755 /home/${{ env.SSH_USERNAME }}/Crystall/
              sudo chown -R ${{ env.SSH_USERNAME }}:${{ env.SSH_USERNAME }} /home/${{ env.SSH_USERNAME }}/Crystall/
            else
              echo "/home/${{ env.SSH_USERNAME }}/Crystall/ not found"
            fi

      - name: Check docker and docker-compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST_NAME }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          run: |
             /home/${{ env.SSH_USERNAME }}/Crystall/devops/check_docker.sh || \
             /home/${{ env.SSH_USERNAME }}/Crystall/devops/install_docker_docker-compose.sh ||
              echo "Did not check Docker"

      - name: Stop docker conteiners and clean docker images
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST_NAME }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            sudo docker stop $(docker ps -aq) && \
            sudo docker system prune --all --force \
            || echo "No docker conteiners are running"

      - name: Start docker compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SSH_HOST_NAME }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            sudo docker compose -f /home/${{ env.SSH_USERNAME }}/Crystall/docker-compose.prod.yml up -d
